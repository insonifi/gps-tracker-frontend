{"ts":1377032370580,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var leafletDirective = angular.module(\"leaflet-directive\", []);\n\nleafletDirective.directive('leaflet', [\n    '$http', '$log', '$parse', '$rootScope', function ($http, $log, $parse, $rootScope) {\n\n    var defaults = {\n        maxZoom: 14,\n        minZoom: 1,\n        doubleClickZoom: true,\n        tileLayer: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n        tileLayerOptions: {\n            attribution: 'Tiles &copy; Open Street Maps'\n        },\n        icon: {\n            url: 'http://cdn.leafletjs.com/leaflet-0.5.1/images/marker-icon.png',\n            retinaUrl: 'http://cdn.leafletjs.com/leaflet-0.5.1/images/marker-icon@2x.png',\n            size: [25, 41],\n            anchor: [12, 40],\n            popup: [0, -40],\n            shadow: {\n                url: 'http://cdn.leafletjs.com/leaflet-0.5.1/images/marker-shadow.png',\n                retinaUrl: 'http://cdn.leafletjs.com/leaflet-0.5.1/images/marker-shadow.png',\n                size: [41, 41],\n                anchor: [12, 40]\n            }\n        },\n        path: {\n            weight: 10,\n            opacity: 1,\n            color: '#0000ff'\n        }\n    };\n\n    var str_inspect_hint = 'Add testing=\"testing\" to <leaflet> tag to inspect this object';\n\n    return {\n        restrict: \"E\",\n        replace: true,\n        transclude: true,\n        scope: {\n            center: '=center',\n            maxBounds: '=maxbounds',\n            bounds: '=bounds',\n            marker: '=marker',\n            markers: '=markers',\n            defaults: '=defaults',\n            paths: '=paths',\n            tiles: '=tiles',\n            events: '=events'\n        },\n        template: '<div class=\"angular-leaflet-map\"></div>',\n        link: function ($scope, element, attrs /*, ctrl */) {\n            var centerModel = {\n                lat:$parse(\"center.lat\"),\n                lng:$parse(\"center.lng\"),\n                zoom:$parse(\"center.zoom\")\n            };\n\n            if (attrs.width) {\n                element.css('width', attrs.width);\n            }\n            if (attrs.height) {\n                element.css('height', attrs.height);\n            }\n\n\n            $scope.leaflet = {};\n\n            $scope.leaflet.maxZoom = !!(attrs.defaults && $scope.defaults && $scope.defaults.maxZoom) ?\n                parseInt($scope.defaults.maxZoom, 10) : defaults.maxZoom;\n            $scope.leaflet.minZoom = !!(attrs.defaults && $scope.defaults && $scope.defaults.minZoom) ?\n                parseInt($scope.defaults.minZoom, 10) : defaults.minZoom;\n            $scope.leaflet.doubleClickZoom = !!(attrs.defaults && $scope.defaults && (typeof($scope.defaults.doubleClickZoom) == \"boolean\") ) ? $scope.defaults.doubleClickZoom  : defaults.doubleClickZoom;\n\n            var map = new L.Map(element[0], {\n                maxZoom: $scope.leaflet.maxZoom,\n                minZoom: $scope.leaflet.minZoom,\n                doubleClickZoom: $scope.leaflet.doubleClickZoom\n            });\n\n           map.setView([0, 0], 1);\n\n            $scope.leaflet.tileLayer = !!(attrs.defaults && $scope.defaults && $scope.defaults.tileLayer) ?\n                $scope.defaults.tileLayer : defaults.tileLayer;\n            $scope.leaflet.map = !!attrs.testing ? map : str_inspect_hint;\n\n            setupTiles();\n            setupCenter();\n            setupMaxBounds();\n            setupBounds();\n            setupMainMaerker();\n            setupMarkers();\n            setupPaths();\n            setupEvents();\n\n\n            // use of leafletDirectiveSetMap event is not encouraged. only use\n            // it when there is no easy way to bind data to the directive\n            $scope.$on('leafletDirectiveSetMap', function(event, message) {\n                var meth = message.shift();\n                map[meth].apply(map, message);\n            });\n\n            $scope.safeApply = function(fn) {\n                var phase = this.$root.$$phase;\n                if (phase == '$apply' || phase == '$digest') {\n                    $scope.$eval(fn);\n                } else {\n                    $scope.$apply(fn);\n                }\n            };\n\n             /*\n              * Event setup watches for callbacks set in the parent scope\n              *\n              *    $scope.events = {\n              *      dblclick: function(){\n              *         // doThis()\n              *      },\n              *      click: function(){\n              *         // doThat()\n              *      }\n              * }\n              * */\n\n             function setupEvents(){\n                 if ( typeof($scope.events) != 'object'){\n                     return false;\n                 }else{\n                     for (var bind_to  in $scope.events){\n                         map.on(bind_to,$scope.events[bind_to]);\n                     }\n                 }\n             }\n\n            function setupTiles(){\n                 // TODO build custom object for tiles, actually only the tile string\n\n                 if ($scope.defaults && $scope.defaults.tileLayerOptions) {\n                    for (var key in $scope.defaults.tileLayerOptions) {\n                        defaults.tileLayerOptions[key] = $scope.defaults.tileLayerOptions[key];\n                    }\n                }\n\n                if ($scope.tiles) {\n                    if ($scope.tiles.tileLayer) {\n                        $scope.leaflet.tileLayer = $scope.tiles.tileLayer;\n                    }\n                    if ($scope.tiles.tileLayerOptions.attribution) {\n                        defaults.tileLayerOptions.attribution = $scope.tiles.tileLayerOptions.attribution;\n                    }\n                }\n\n                var tileLayerObj = L.tileLayer(\n                    $scope.leaflet.tileLayer, defaults.tileLayerOptions);\n                tileLayerObj.addTo(map);\n\n                $scope.leaflet.tileLayerObj = !!attrs.testing ? tileLayerObj : str_inspect_hint;\n            }\n\n            function setupMaxBounds() {\n                if (!$scope.maxBounds) {\n                    return;\n                }\n                if ($scope.maxBounds.southWest && $scope.maxBounds.southWest.lat && $scope.maxBounds.southWest.lng && $scope.maxBounds.northEast && $scope.maxBounds.northEast.lat && $scope.maxBounds.northEast.lng) {\n                    map.setMaxBounds(\n                        new L.LatLngBounds(\n                            new L.LatLng($scope.maxBounds.southWest.lat, $scope.maxBounds.southWest.lng),\n                            new L.LatLng($scope.maxBounds.northEast.lat, $scope.maxBounds.northEast.lng)\n                        )\n                    );\n\n                    $scope.$watch(\"maxBounds\", function (maxBounds) {\n                        if (maxBounds.southWest && maxBounds.northEast && maxBounds.southWest.lat && maxBounds.southWest.lng && maxBounds.northEast.lat && maxBounds.northEast.lng) {\n                            map.setMaxBounds(\n                                new L.LatLngBounds(\n                                    new L.LatLng(maxBounds.southWest.lat, maxBounds.southWest.lng),\n                                    new L.LatLng(maxBounds.northEast.lat, maxBounds.northEast.lng)\n                                )\n                            );\n                        }\n                    });\n                }\n            }\n\n            function tryFitBounds(bounds) {\n                if (bounds) {\n                    var southWest = bounds.southWest;\n                    var northEast = bounds.northEast;\n                    if (southWest && northEast && southWest.lat && southWest.lng && northEast.lat && northEast.lng) {\n                        var sw_latlng = new L.LatLng(southWest.lat, southWest.lng);\n                        var ne_latlng = new L.LatLng(northEast.lat, northEast.lng);\n                        map.fitBounds(new L.LatLngBounds(sw_latlng, ne_latlng));\n                    }\n                }\n            }\n\n            function setupBounds() {\n                if (!$scope.bounds) {\n                    return;\n                }\n                $scope.$watch('bounds', function (new_bounds) {\n                    tryFitBounds(new_bounds);\n                });\n            }\n\n            function setupCenter() {\n                $scope.$watch(\"center\", function (center) {\n                    if (!center) {\n                        $log.warn(\"[AngularJS - Leaflet] 'center' is undefined in the current scope, did you forget to initialize it?\");\n                        return;\n                    }\n                    if (center.lat && center.lng && center.zoom) {\n                        map.setView([center.lat, center.lng], center.zoom);\n                    } else if (center.autoDiscover === true) {\n                        map.locate({ setView: true, maxZoom: $scope.leaflet.maxZoom });\n                    }\n                }, true);\n\n                map.on(\"dragend\", function (/* event */) {\n                    $scope.safeApply(function (scope) {\n                        centerModel.lat.assign(scope, map.getCenter().lat);\n                        centerModel.lng.assign(scope, map.getCenter().lng);\n                    });\n                });\n\n                map.on(\"zoomend\", function (/* event */) {\n                    if(angular.isUndefined($scope.center)){\n                        $log.warn(\"[AngularJS - Leaflet] 'center' is undefined in the current scope, did you forget to initialize it?\");\n                    }\n                    if (angular.isUndefined($scope.center) || $scope.center.zoom !== map.getZoom()) {\n                        $scope.safeApply(function (s) {\n                            centerModel.zoom.assign(s, map.getZoom());\n                            centerModel.lat.assign(s, map.getCenter().lat);\n                            centerModel.lng.assign(s, map.getCenter().lng);\n                        });\n                    }\n                });\n            }\n\n            function setupMainMaerker() {\n                var main_marker;\n                if (!$scope.marker) {\n                    return;\n                }\n                main_marker = createMarker('marker', $scope.marker, map);\n                $scope.leaflet.marker = !!attrs.testing ? main_marker : str_inspect_hint;\n                main_marker.on('click', function(e) {\n                    $rootScope.$apply(function() {\n                        $rootScope.$broadcast('leafletDirectiveMainMarkerClick');\n                    });\n                });\n            }\n\n            function setupMarkers() {\n                var markers = {};\n                $scope.leaflet.markers = !!attrs.testing ? markers : str_inspect_hint;\n                if (!$scope.markers) {\n                    return;\n                }\n\n                function genMultiMarkersClickCallback(m_name) {\n                    return function(e) {\n                        $rootScope.$apply(function() {\n                            $rootScope.$broadcast('leafletDirectiveMarkersClick', m_name);\n                        });\n                    };\n                }\n\n                for (var name in $scope.markers) {\n                    markers[name] = createMarker(\n                            'markers.'+name, $scope.markers[name], map);\n                    markers[name].on('click', genMultiMarkersClickCallback(name));\n                }\n\n                $scope.$watch('markers', function(newMarkers) {\n                    // Delete markers from the array\n                    for (var name in markers) {\n                        if (newMarkers[name] === undefined) {\n                            delete markers[name];\n                        }\n                    }\n                    // add new markers\n                    for (var new_name in newMarkers) {\n                        if (markers[new_name] === undefined) {\n                            markers[new_name] = createMarker(\n                                'markers.'+new_name, newMarkers[new_name], map);\n                            markers[new_name].on('click', genMultiMarkersClickCallback(new_name));\n                        }\n                    }\n                }, true);\n            }\n\n            function createMarker(scope_watch_name, marker_data, map) {\n                var marker = buildMarker(marker_data);\n                map.addLayer(marker);\n\n                if (marker_data.focus === true) {\n                    marker.openPopup();\n                }\n\n                marker.on(\"dragend\", function () {\n                    $scope.safeApply(function (scope) {\n                        marker_data.lat = marker.getLatLng().lat;\n                        marker_data.lng = marker.getLatLng().lng;\n                    });\n                    if (marker_data.message) {\n                        marker.openPopup();\n                    }\n                });\n\n                var clearWatch = $scope.$watch(scope_watch_name, function (data, old_data) {\n                    if (!data) {\n                        map.removeLayer(marker);\n                        clearWatch();\n                        return;\n                    }\n\n                    if (old_data) {\n                        if (data.draggable !== undefined && data.draggable !== old_data.draggable) {\n                            if (data.draggable === true) {\n                                marker.dragging.enable();\n                            } else {\n                                marker.dragging.disable();\n                            }\n                        }\n\n                        if (data.focus !== undefined && data.focus !== old_data.focus) {\n                            if (data.focus === true) {\n                                marker.openPopup();\n                            } else {\n                                marker.closePopup();\n                            }\n                        }\n\n                        if (data.message !== undefined && data.message !== old_data.message) {\n                            marker.bindPopup(data);\n                        }\n\n                        if (data.lat !== old_data.lat || data.lng !== old_data.lng) {\n                            marker.setLatLng(new L.LatLng(data.lat, data.lng));\n                        }\n\n                        if (data.icon && data.icon !== old_data.icon) {\n                            marker.setIcon(data.icon);\n                        }\n                    }\n                }, true);\n                return marker;\n            }\n\n            function buildMarker(data) {\n                var micon = null;\n                if (data.icon) {\n                    micon = data.icon;\n                } else {\n                    micon = buildIcon();\n                }\n                var marker = new L.marker(data,\n                    {\n                        icon: micon,\n                        draggable: data.draggable ? true : false\n                    }\n                );\n                if (data.message) {\n                    marker.bindPopup(data.message);\n                }\n                return marker;\n            }\n\n            function buildIcon() {\n                return L.icon({\n                    iconUrl: defaults.icon.url,\n                    iconRetinaUrl: defaults.icon.retinaUrl,\n                    iconSize: defaults.icon.size,\n                    iconAnchor: defaults.icon.anchor,\n                    popupAnchor: defaults.icon.popup,\n                    shadowUrl: defaults.icon.shadow.url,\n                    shadowRetinaUrl: defaults.icon.shadow.retinaUrl,\n                    shadowSize: defaults.icon.shadow.size,\n                    shadowAnchor: defaults.icon.shadow.anchor\n                });\n            }\n\n            function setupPaths() {\n                var paths = {};\n                $scope.leaflet.paths = !!attrs.testing ? paths : str_inspect_hint;\n\n                if (!$scope.paths) {\n                    return;\n                }\n\n                $log.warn(\"[AngularJS - Leaflet] Creating polylines and adding them to the map will break the directive's scope's inspection in AngularJS Batarang\");\n\n                for (var name in $scope.paths) {\n                    paths[name] = createPath(name, $scope.paths[name], map);\n                }\n\n                $scope.$watch(\"paths\", function (newPaths) {\n                    for (var new_name in newPaths) {\n                        if (paths[new_name] === undefined) {\n                            paths[new_name] = createPath(new_name, newPaths[new_name], map);\n                        }\n                    }\n                    // Delete paths from the array\n                    for (var name in paths) {\n                        if (newPaths[name] === undefined) {\n                            delete paths[name];\n                        }\n                    }\n\n                }, true);\n            }\n\n            function createPath(name, scopePath, map) {\n                var polyline = new L.Polyline([], {\n                    weight: defaults.path.weight,\n                    color: defaults.path.color,\n                    opacity: defaults.path.opacity\n                });\n\n                if (scopePath.latlngs !== undefined) {\n                    var latlngs = convertToLeafletLatLngs(scopePath.latlngs);\n                    polyline.setLatLngs(latlngs);\n                }\n\n                if (scopePath.weight !== undefined) {\n                    polyline.setStyle({ weight: scopePath.weight });\n                }\n\n                if (scopePath.color !== undefined) {\n                    polyline.setStyle({ color: scopePath.color });\n                }\n\n                if (scopePath.opacity !== undefined) {\n                    polyline.setStyle({ opacity: scopePath.opacity });\n                }\n\n                map.addLayer(polyline);\n\n                var clearWatch = $scope.$watch('paths.' + name, function (data, oldData) {\n                    if (!data) {\n                        map.removeLayer(polyline);\n                        clearWatch();\n                        return;\n                    }\n\n                    if (oldData) {\n                        if (data.latlngs !== undefined && data.latlngs !== oldData.latlngs) {\n                            var latlngs = convertToLeafletLatLngs(data.latlngs);\n                            polyline.setLatLngs(latlngs);\n                        }\n\n                        if (data.weight !== undefined && data.weight !== oldData.weight) {\n                            polyline.setStyle({ weight: data.weight });\n                        }\n\n                        if (data.color !== undefined && data.color !== oldData.color) {\n                            polyline.setStyle({ color: data.color });\n                        }\n\n                        if (data.opacity !== undefined && data.opacity !== oldData.opacity) {\n                            polyline.setStyle({ opacity: data.opacity });\n                        }\n                    }\n                }, true);\n                return polyline;\n            }\n\n            function convertToLeafletLatLngs(latlngs) {\n                var leafletLatLngs = latlngs.filter(function (latlng) {\n                    return !!latlng.lat && !!latlng.lng;\n                }).map(function (latlng) {\n                    return new L.LatLng(latlng.lat, latlng.lng);\n                });\n\n                return leafletLatLngs;\n            }\n        }\n    };\n}]);\n"]],"start1":0,"start2":0,"length1":0,"length2":19323}]],"length":19323}
